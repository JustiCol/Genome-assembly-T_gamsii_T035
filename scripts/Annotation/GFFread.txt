#!/bin/bash

###############################################################################
#                          SLURM job submission script
#                 Extract CDS, proteins, and transcripts with gffread
###############################################################################

# SLURM options
#SBATCH --job-name=GFFread              # Job name
#SBATCH --cpus-per-task=10              # Number of cores
#SBATCH --mem=10G                       # Memory needed
#SBATCH --output=reports/%j-%x.out      # Output log (%j = job ID, %x = job name)
##SBATCH --mail-user=your.email@domain   # Uncomment to receive email notifications
##SBATCH --mail-type=ALL

###############################################################################
#                        Conda environment activation
###############################################################################

# Ensure conda is initialized
eval "$(conda shell.bash hook)"
source /path/to/miniconda3/etc/profile.d/conda.sh

# Activate environment containing gffread
conda activate gffread_env

# Stop on errors and undefined variables, fail on pipe errors
set -euo pipefail

###############################################################################
#                                Input files
###############################################################################

# Example dataset 1
WORKDIR1="/path/to/workdir/sample1"
GENOME1="/path/to/genome/sample1.fasta"
GFF1="/path/to/annotation/sample1.gff"


###############################################################################
#                             Run gffread 
###############################################################################

mkdir -p "$WORKDIR1"
cd "$WORKDIR1"

gffread "$GFF1" \
    -g "$GENOME1" \
    -x cds.fa \
    -y proteins.fa \
    -w transcripts.fa

###############################################################################
#                             Job summary report
###############################################################################

echo "SLURM job ID: $SLURM_JOB_ID"
sacct -j "$SLURM_JOB_ID" --format=JobID,JobName,Elapsed,TotalCPU,MaxRSS

echo "Job completed successfully."
